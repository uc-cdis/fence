#!/usr/bin/env python

import argparse
import os
import sys

from fence.scripting.fence_create import (
    create_client_action,
    create_sample_data,
    delete_client_action,
    delete_users,
    google_init,
    sync_users,
    remove_expired_google_service_account_keys,
    create_user_token,
    remove_expired_google_accounts_from_proxy_groups
)

def str2bool(v):
    if v.lower() == 'true':
        return True
    elif v.lower() == 'false':
        return False
    else:
        raise argparse.ArgumentTypeError('Boolean value expected.')

def parse_arguments():
    parser = argparse.ArgumentParser()
    parser.add_argument(
        '--path',
        default='/var/www/fence/',
        help='path to find local_settings.py',
    )

    subparsers = parser.add_subparsers(title='action', dest='action')

    create = subparsers.add_parser('create')
    create.add_argument('yaml-input')

    client_create = subparsers.add_parser('client-create')
    client_create.add_argument('--client', required=True)
    client_create.add_argument('--urls', required=True)
    client_create.add_argument(
        '--username',
        help='user(can represent an organization) that owns the client',
        required=True)
    client_create.add_argument(
        '--external',
        help='is this an external oidc client',
        action="store_true", default=False
    )

    client_delete = subparsers.add_parser('client-delete')
    client_delete.add_argument('--client', required=True)

    user_delete = subparsers.add_parser('user-delete')
    user_delete.add_argument('--users', required=True, nargs='+')

    hmac_create = subparsers.add_parser('hmac-create')
    hmac_create.add_argument('yaml-input')

    dbgap_sync = subparsers.add_parser('sync')
    dbgap_sync.add_argument(
        '--projects',
        dest='project_mapping',
        required=True,
        help='Specify project mapping yaml file')
    dbgap_sync.add_argument(
        '--yaml',
        help='Sync from yaml file')
    dbgap_sync.add_argument(
        '--csv_dir',
        help='specify csv file directory')
    dbgap_sync.add_argument(
        '--sync_from_dbgap',
        help='sync from dbgap server True/False',
        default='True')

    manage_google_keys = subparsers.add_parser('google-manage-keys')
    init_google = subparsers.add_parser('google-init')
    manage_google_accounts = (
        subparsers.add_parser('google-manage-account-access')
    )

    token_create = subparsers.add_parser('token-create')
    token_create.add_argument('--kid')
    token_create.add_argument('--type', required=True)
    token_create.add_argument('--username', required=True)
    token_create.add_argument('--scopes', required=True)
    token_create.add_argument('--exp')

    return parser.parse_args()


def main():
    args = parse_arguments()

    # get database information
    sys.path.append(args.path)

    if os.environ.get('FENCE_DB'):
        DB = os.environ['FENCE_DB']
    else:
        from fence.settings import DB

    if os.environ.get('BASE_URL'):
        DB = os.environ['BASE_URL']
    else:
        from fence.settings import BASE_URL

    if os.environ.get('ROOT_DIR'):
        ROOT_DIR = os.environ['ROOT_DIR']
    else:
        ROOT_DIR = '/fence'

    if os.environ.get('dbGaP'):
        dbGaP = os.environ['dbGaP']
    else:
        from fence.settings import dbGaP

    if os.environ.get('STORAGE_CREDENTIALS'):
        STORAGE_CREDENTIALS = os.environ['STORAGE_CREDENTIALS']
    else:
        from fence.settings import STORAGE_CREDENTIALS

    if args.action == 'create':
        yaml_input = args.__dict__['yaml-input']
        create_sample_data(DB, yaml_input)
    elif args.action == 'client-create':
        create_client_action(
            DB, username=args.username, client=args.client,
            urls=args.urls, auto_approve=(not args.external)
        )
    elif args.action == 'client-delete':
        delete_client_action(DB, args.client)
    elif args.action == 'user-delete':
        delete_users(DB, args.users)
    elif args.action == 'sync':
        sync_users(dbGaP, STORAGE_CREDENTIALS, DB,
                   projects=args.project_mapping, is_sync_from_dbgap_server=str2bool(args.sync_from_dbgap),
                   sync_from_local_csv_dir=args.csv_dir, sync_from_local_yaml_file=args.yaml)
    elif args.action == 'google-manage-keys':
        remove_expired_google_service_account_keys(DB)
    elif args.action == 'google-init':
        google_init(DB)
    elif args.action == 'google-manage-account-access':
        remove_expired_google_accounts_from_proxy_groups(DB)
    elif args.action == 'token-create':
        token = create_user_token(
            DB, BASE_URL, ROOT_DIR, args.__dict__['kid'],
            args.__dict__['type'], args.__dict__['username'],
            args.__dict__['scopes'], args.__dict__['exp'])
        if token:
            print(token)


if __name__ == '__main__':
    main()
